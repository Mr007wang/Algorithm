## 1.概述

CFS（completely fair schedule）是最终被内核采纳的调度器。它从RSDL/SD中吸取了完全公平的思想，不再跟踪进程的睡眠时间，也不再企图区分交互式进程。 **它将所有的进程都统一对待** ，这就是公平的含义。CFS的算法和实现都相当简单，众多的测试表明其性能也非常优越。


CFS 背后的主要想法是 **维护为任务提供处理器时间方面的平衡**（公平性）。这意味着应给进程分配相当数量的处理器。分给某个任务的时间失去平衡时（意味着一个或多个任务相对于其他任务而言未被给予相当数量的时间），应给失去平衡的任务分配时间，让其执行。


CFS抛弃了时间片，抛弃了复杂的算法，从一个新的起点开始了调度器的新时代，最开始的2.6.23版本，CFS提供一个虚拟的时钟，所有进程复用这个虚拟时钟的时间，**CFS将时钟的概念从底层体系相关的硬件中抽象出来，进程调度模块直接和这个虚拟的时钟接口 而不必再为硬件时钟操作而操心** ，如此一来，整个进程调度模块就完整了，从时钟到调度算法，到不同进程的不同策略，全部都由虚拟系统提供，也正是在这个新的内核，引入了调度类。因此新的调度器就是不同特性的进程在统一的虚拟时钟下按照不同的策略被调度。


按照作者Ingo Molnar的说法："CFS百分之八十的工作可以用一句话概括：CFS在真实的硬件上模拟了完全理想的多任务处理器"。在“完全理想的多任务处理器 “下，**每个进程都能同时获得CPU的执行时间** 。当系统中有两个进程时，CPU的计算时间被分成两份，每个进程获得50%。然而在实际的硬件上，当一个进程占用CPU时，其它进程就必须等待。这就产生了不公平。


## 2.CFS的核心思想

完全公平调度器和传统的 **Unix** 进程调度器有很大的区别,在大多数 **Unix** 系统中,包括引入CFS之前的Linux系统,在进程调度中存在两个基本的基于进程的因素, **优先级** 和 **时间片** .在传统的进程调度器中,会给每个就绪进程分配一个时间片,表示分配给该进程的处理器分片.进程可能会一直运行到消耗完其分配的到的时间片.此外,还给每个进程分配优先级.进程调度器会优先调度运行优先级高的进程,然后再运行优先级低的系统.这个调度算法非常简单,而且对于早期的基于时间片共享的 **Unix** 系统效果良好.但是,需要交互和公平性的系统而言,比如现代计算机的桌面和移动设备,该算法就有些差强人意了.

完全公平调度器引入了一种非常不同的算法,成为公平调度,它消除了时间片作为处理器访问单元,相反地,它给每个进程分配了处理器的时间比例,算法很简单,CFS在最初给 **N** 个进程分别分配 **1/N** 的处理器时间,然后, CFS通过优先级权衡每个进程的比例,调整分配.默认的优先级为 **0** ,权值为 **1** ,则比例不变,优先级的值设定越小(优先级越高),权值就越高,就增加分配给该进程的处理器的比例值,优先级的值设置越高(优先级越低),权值越低,就减少分配给该进程的处理器的比例值.

通过这种方式,完全公平调度器就给每个进程分配了基于权值的处理器比例,要确定每个进程真正的执行时间,完全公平调度器需要把比例划分成一个固定的周期,该周期称为"目标延迟", 它表示系统的延迟调度,下面我们举个例子,可以帮助了解"目标延迟"这个概念,假设"目标延迟"设置为 **20ms** ,存在两个优先级相同的可运行进程,每个进程有相同的权值,并被分配相同的处理器比例,每个进程占用 **10ms** ,这样,完全公平调度器就会先执行一个进程,运行 **10ms** ,然后执行另外一个进程,也运行 **10ms** ,这样不断重复,如果系统中有5个可运行的进程,完全公平调度器会每个运行 **4ms** .

目前看来一切都不错,没什么问题,但是,当有 **200** 个可运行进程时,怎么办?如果目标延迟是 **20ms** ,完全公平调度器会给每个进程仅分配 100微秒,由于从一个进程到另一个进程的上下文切换会带来开销(切换开销).以及无法更好地利用时间局部性,基于以上问题,完全公平调度器引入了另外一个关键因素: **最小粒度**.

"最小粒度"是指任一进程所运行的时间长的基准值.所有进程,不管其分配到的处理器比例是多少,都至少会运行最小粒度的时间.这种机制可以保证切换代价不会因为目标延迟值很小,而占用过大比例的系统总时间.也就是说,如果在最小粒度内切换进程,就破坏了公平性,设置了目标延迟和最小粒度之后,在可运行进程数合理的情况下,不需要应用最小粒度,只需要满足目标延迟,就可以保证公平性.

通过给进程分配处理器资源比例,而不是固定时间片,完全公平调度可以实现公平性:每个进程都获得了处理器资源的"公平份额".此外,完全公平调度器还可以支持可配置的调度延迟,因为目标延迟是用户可以设置的.在传统的 **Unix** 调度器中,进程运行几个固定的时间片,成为"priori(先验值)",但调度延迟(运行频率)是未知的.在完全公平调度器中,进程按"配额"运行,其延迟被称为"priori",时间片是根据系统上可运行的进程数而动态变化的.完全公平调度器是完全不同的处理进程调度方案,解决了传统进程调度器对于交互进程和 **I/O** 约束型进程所面临的很多问题.
